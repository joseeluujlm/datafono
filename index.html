<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TapPay</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #05050a;
  --surface: #0e0e18;
  --card: #141422;
  --card2: #1a1a2e;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --lime: #c6ff00;
  --lime2: #a8e600;
  --blue: #4d9fff;
  --text: #f0f0f8;
  --sub: #8888aa;
  --dot: #2a2a40;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html, body {
  width:100%; height:100%;
  overflow:hidden;
  background:var(--bg);
  color:var(--text);
  font-family:'Plus Jakarta Sans',sans-serif;
  -webkit-font-smoothing:antialiased;
}

/* SLIDER */
.slider {
  display:flex;
  width:300%;
  height:100%;
  transition:transform 0.45s cubic-bezier(0.77,0,0.18,1);
  will-change:transform;
}

.slide {
  width:33.333%;
  height:100%;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
  overscroll-behavior:contain;
}
.slide::-webkit-scrollbar{display:none;}
.slide{scrollbar-width:none;}

/* ‚îÄ‚îÄ SLIDE 1 ‚îÄ‚îÄ */
#s1{background:var(--bg);}

.s1-inner{
  display:flex;
  flex-direction:column;
  padding:calc(var(--safe-top) + 20px) 22px calc(var(--safe-bot) + 24px);
  min-height:100%;
  gap:0;
}

.status-bar{
  display:flex; justify-content:space-between; align-items:center;
  padding:4px 0 16px;
  font-size:12px; font-weight:600;
  color:var(--sub); font-family:'DM Mono',monospace;
}
.status-icons{display:flex;gap:6px;align-items:center;}

.app-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;}
.app-logo{display:flex;align-items:center;gap:10px;}
.logo-mark{
  width:38px;height:38px;
  background:var(--lime);border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:19px;flex-shrink:0;
}
.logo-text{font-size:20px;font-weight:800;letter-spacing:-0.5px;}
.logo-text span{color:var(--lime);}
.header-badge{
  background:var(--card);border:1px solid var(--border2);
  border-radius:100px;padding:6px 12px;
  font-size:11px;font-family:'DM Mono',monospace;
  color:var(--lime);letter-spacing:1px;
}

.section-eyebrow{
  font-size:10px;font-family:'DM Mono',monospace;
  color:var(--sub);text-transform:uppercase;letter-spacing:2.5px;margin-bottom:10px;
}

.amount-display{display:flex;align-items:flex-start;gap:6px;margin-bottom:16px;}
.euro-sign{font-size:32px;font-weight:700;color:var(--lime);margin-top:10px;line-height:1;}

.amount-input-big{
  font-size:72px;font-weight:800;
  font-family:'Plus Jakarta Sans',sans-serif;
  background:transparent;border:none;outline:none;
  color:var(--text);width:100%;line-height:1;
  letter-spacing:-3px;caret-color:var(--lime);
}
.amount-input-big::placeholder{color:var(--dot);}

.quick-row{
  display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;
  margin-bottom:24px;-webkit-overflow-scrolling:touch;
}
.quick-row::-webkit-scrollbar{display:none;}

.qbtn{
  flex-shrink:0;background:var(--card);border:1px solid var(--border2);
  border-radius:100px;padding:10px 18px;
  font-family:'DM Mono',monospace;font-size:13px;color:var(--sub);
  cursor:pointer;transition:all 0.15s;user-select:none;-webkit-user-select:none;
}
.qbtn:active,.qbtn.active{background:var(--lime);color:var(--bg);border-color:var(--lime);font-weight:700;}

.divider-line{height:1px;background:var(--border);margin-bottom:20px;}

.upload-label-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}

.upload-zone{
  width:100%;min-height:140px;
  border:1.5px dashed var(--dot);border-radius:18px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:8px;cursor:pointer;position:relative;overflow:hidden;
  transition:border-color 0.2s,background 0.2s;margin-bottom:24px;
  background:var(--surface);
}
.upload-zone:active{background:var(--card);}
.upload-zone.filled{border-color:var(--lime);border-style:solid;min-height:160px;}
.upload-zone.filled img{width:100%;height:160px;object-fit:cover;display:block;}
.uz-icon{font-size:30px;}
.uz-text{font-size:13px;color:var(--sub);text-align:center;line-height:1.4;}
.uz-text b{color:var(--text);}
.uz-overlay{
  position:absolute;inset:0;background:rgba(0,0,0,0.55);
  display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity 0.2s;font-size:13px;font-weight:600;
  gap:6px;border-radius:16px;
}
.upload-zone.filled:active .uz-overlay{opacity:1;}
#file-input{display:none;}

.flex-grow{flex:1;}

.cta-main{
  width:100%;background:var(--lime);color:var(--bg);
  border:none;border-radius:18px;padding:20px 24px;
  font-family:'Plus Jakarta Sans',sans-serif;font-size:17px;font-weight:800;
  display:flex;align-items:center;justify-content:space-between;
  cursor:pointer;transition:all 0.15s;letter-spacing:-0.3px;
}
.cta-main:active{transform:scale(0.98);background:var(--lime2);}
.cta-main:disabled{background:var(--card);color:var(--sub);cursor:not-allowed;}
.cta-arrow{
  width:36px;height:36px;background:rgba(0,0,0,0.15);
  border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;
}
.swipe-hint{
  text-align:center;font-size:11px;font-family:'DM Mono',monospace;
  color:var(--dot);margin-top:12px;letter-spacing:1px;
}

/* ‚îÄ‚îÄ SLIDE 2 ‚îÄ‚îÄ */
#s2{background:radial-gradient(ellipse 100% 60% at 50% 0%,rgba(77,159,255,0.12) 0%,transparent 70%),var(--bg);}

.s2-inner{
  display:flex;flex-direction:column;align-items:center;
  padding:calc(var(--safe-top) + 24px) 24px calc(var(--safe-bot) + 32px);
  min-height:100%;gap:0;
}

.pay-topbar{width:100%;display:flex;align-items:center;justify-content:space-between;margin-bottom:36px;}
.pay-back{
  width:40px;height:40px;background:var(--card);border:1px solid var(--border2);
  border-radius:12px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:16px;transition:all 0.15s;
}
.pay-back:active{background:var(--card2);transform:scale(0.92);}
.pay-title{font-size:15px;font-weight:600;color:var(--sub);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:1.5px;}
.pay-secure{display:flex;align-items:center;gap:5px;font-size:12px;font-family:'DM Mono',monospace;color:var(--lime);}

.amount-card{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:24px;padding:24px;text-align:center;margin-bottom:32px;
}
.ac-label{font-size:11px;font-family:'DM Mono',monospace;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;}
.ac-amount{font-size:clamp(52px,14vw,68px);font-weight:800;letter-spacing:-3px;line-height:1;color:var(--text);}
.ac-sub{font-size:12px;font-family:'DM Mono',monospace;color:var(--sub);margin-top:6px;}

.nfc-stage{
  width:220px;height:220px;position:relative;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.nfc-ring{
  position:absolute;border-radius:50%;
  border:1.5px solid rgba(77,159,255,0.5);
  animation:nfcPulse 2.4s ease-out infinite;
}
.nfc-ring:nth-child(1){width:90px;height:90px;animation-delay:0s;}
.nfc-ring:nth-child(2){width:140px;height:140px;animation-delay:0.5s;}
.nfc-ring:nth-child(3){width:195px;height:195px;animation-delay:1s;}
@keyframes nfcPulse{
  0%{opacity:0.8;transform:scale(0.85);}
  100%{opacity:0;transform:scale(1);}
}
.nfc-core{
  width:76px;height:76px;
  background:linear-gradient(135deg,#1a2a4a,#0d1520);
  border:2px solid rgba(77,159,255,0.6);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  position:relative;z-index:2;
  box-shadow:0 0 30px rgba(77,159,255,0.2),inset 0 1px 0 rgba(255,255,255,0.08);
  transition:all 0.2s;
}
.nfc-stage:active .nfc-core{transform:scale(1.12);box-shadow:0 0 50px rgba(77,159,255,0.4);}
.nfc-icon{font-size:30px;}
.nfc-text{text-align:center;}
.nfc-text-main{font-size:17px;font-weight:700;margin-bottom:4px;}
.nfc-text-sub{font-size:13px;color:var(--sub);font-family:'DM Mono',monospace;}

.sim-btn{
  width:100%;background:var(--card2);border:1px solid var(--border2);
  border-radius:16px;padding:18px;
  display:flex;align-items:center;justify-content:center;gap:10px;
  font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:700;
  color:var(--blue);cursor:pointer;transition:all 0.15s;margin-bottom:12px;
}
.sim-btn:active{transform:scale(0.97);background:var(--card);}

.cancel-link{
  text-align:center;font-size:13px;font-family:'DM Mono',monospace;
  color:var(--sub);cursor:pointer;padding:8px;
}
.cancel-link:active{color:var(--text);}

/* NFC panel states */
.nfc-panel{
  flex:1;display:flex;align-items:center;justify-content:center;
  width:100%;margin-bottom:24px;
}
.nfc-state{width:100%;display:flex;flex-direction:column;align-items:center;gap:20px;}
.nfc-state.hidden{display:none;}

/* idle state */
.nfc-stage-idle{
  display:flex;flex-direction:column;align-items:center;gap:16px;cursor:pointer;
}
.nfc-core-idle{
  width:110px;height:110px;
  background:var(--card2);border:2px dashed rgba(77,159,255,0.3);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;
  box-shadow:0 0 0 0 rgba(77,159,255,0.2);
  animation:idlePulse 2.5s ease infinite;
}
@keyframes idlePulse{
  0%,100%{box-shadow:0 0 0 0 rgba(77,159,255,0.15);}
  50%{box-shadow:0 0 0 18px rgba(77,159,255,0);}
}
.nfc-stage-idle:active .nfc-core-idle{
  background:rgba(77,159,255,0.1);border-color:var(--blue);transform:scale(1.05);
}
.nfc-idle-label{
  font-size:15px;font-weight:700;color:var(--blue);text-align:center;
}

/* retry button */
.retry-btn{
  margin-top:14px;background:transparent;border:1px solid var(--border2);
  border-radius:10px;padding:10px 20px;
  font-family:'DM Mono',monospace;font-size:12px;
  color:var(--sub);cursor:pointer;transition:all 0.15s;
  text-transform:uppercase;letter-spacing:1px;
}
.retry-btn:active{border-color:var(--blue);color:var(--blue);}

/* ‚îÄ‚îÄ SLIDE 3 ‚îÄ‚îÄ */
#s3{background:var(--bg);}

.s3-inner{
  display:flex;flex-direction:column;
  padding:calc(var(--safe-top) + 24px) 22px calc(var(--safe-bot) + 32px);
  min-height:100%;gap:0;
}

.success-topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;}
.success-chip{
  display:flex;align-items:center;gap:7px;
  background:rgba(198,255,0,0.1);border:1px solid rgba(198,255,0,0.25);
  border-radius:100px;padding:7px 14px;
  font-size:12px;font-family:'DM Mono',monospace;
  color:var(--lime);letter-spacing:1px;text-transform:uppercase;
}
.chip-dot{width:7px;height:7px;background:var(--lime);border-radius:50%;animation:blink 1.2s ease infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.2;}}
.success-topbar-right{font-size:12px;font-family:'DM Mono',monospace;color:var(--sub);}

.success-hero{text-align:center;padding:16px 0 28px;}
.success-tick{
  width:72px;height:72px;
  background:rgba(198,255,0,0.1);border:2px solid rgba(198,255,0,0.4);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:32px;margin:0 auto 16px;
  animation:popIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
}
@keyframes popIn{from{transform:scale(0);opacity:0;}to{transform:scale(1);opacity:1;}}
.success-title-main{font-size:32px;font-weight:800;letter-spacing:-1px;color:var(--lime);margin-bottom:4px;animation:slideUp 0.4s ease both;animation-delay:0.1s;}
.success-amount-hero{font-size:48px;font-weight:800;letter-spacing:-2px;color:var(--text);animation:slideUp 0.4s ease both;animation-delay:0.2s;}
@keyframes slideUp{from{transform:translateY(16px);opacity:0;}to{transform:translateY(0);opacity:1;}}

.img-frame{width:100%;border-radius:20px;overflow:hidden;position:relative;margin-bottom:20px;animation:slideUp 0.5s ease both;animation-delay:0.3s; cursor:pointer;}
.img-frame img{width:100%;max-height:240px;object-fit:cover;display:block;transition:transform 0.2s;}
.img-frame:active img{transform:scale(0.98);}
.img-frame-label{position:absolute;bottom:0;left:0;right:0;padding:14px 16px 14px;background:linear-gradient(transparent,rgba(0,0,0,0.75));font-size:12px;font-family:'DM Mono',monospace;color:rgba(255,255,255,0.6);}
.img-expand-icon{
  position:absolute;top:12px;right:12px;
  width:32px;height:32px;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:15px;color:#fff;
  border:1px solid rgba(255,255,255,0.15);
}

/* Fullscreen viewer */
.fs-viewer{
  position:fixed;inset:0;z-index:2000;
  background:#000;
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity 0.3s ease;
  cursor:zoom-out;
}
.fs-viewer.open{opacity:1;pointer-events:all;}
.fs-viewer img{
  width:100%;height:100%;
  object-fit:contain;
  transform:scale(0.92);
  transition:transform 0.35s cubic-bezier(0.34,1.3,0.64,1);
  user-select:none;-webkit-user-select:none;
}
.fs-viewer.open img{transform:scale(1);}
.fs-close{
  position:absolute;top:calc(var(--safe-top) + 16px);right:16px;
  width:38px;height:38px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;color:#fff;font-weight:700;
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
}
.fs-hint{
  position:absolute;bottom:calc(var(--safe-bot) + 20px);
  left:50%;transform:translateX(-50%);
  font-size:12px;font-family:'DM Mono',monospace;
  color:rgba(255,255,255,0.35);
  letter-spacing:1px;
  animation:blink 2s ease infinite;
  white-space:nowrap;
}

.no-img-box{
  width:100%;height:100px;background:var(--card);
  border:1px dashed var(--border2);border-radius:20px;
  display:flex;align-items:center;justify-content:center;gap:8px;
  font-size:13px;color:var(--sub);margin-bottom:20px;
  font-family:'DM Mono',monospace;
  animation:slideUp 0.5s ease both;animation-delay:0.3s;
}

.txn-card{
  background:var(--card);border:1px solid var(--border2);
  border-radius:20px;padding:20px;margin-bottom:20px;
  display:flex;flex-direction:column;
  animation:slideUp 0.4s ease both;animation-delay:0.35s;
}
.txn-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;}
.txn-row:not(:last-child){border-bottom:1px solid var(--border);}
.txn-k{font-size:12px;font-family:'DM Mono',monospace;color:var(--sub);text-transform:uppercase;letter-spacing:1px;}
.txn-v{font-size:13px;font-family:'DM Mono',monospace;color:var(--text);}
.txn-v.ok{color:var(--lime);}

.reset-btn{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:18px;padding:18px;
  font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;font-weight:700;
  color:var(--sub);cursor:pointer;text-align:center;transition:all 0.15s;
  animation:slideUp 0.4s ease both;animation-delay:0.4s;
}
.reset-btn:active{background:var(--card2);color:var(--text);}

/* OVERLAY */
.overlay{
  position:fixed;inset:0;
  background:rgba(5,5,10,0.92);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  z-index:999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  opacity:0;pointer-events:none;transition:opacity 0.3s;
}
.overlay.show{opacity:1;pointer-events:all;}
.ov-rings{width:140px;height:140px;position:relative;display:flex;align-items:center;justify-content:center;}
.ov-spin{position:absolute;inset:0;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin 0.9s linear infinite;}
.ov-spin2{position:absolute;inset:12px;border:1.5px solid transparent;border-bottom-color:var(--lime);border-radius:50%;animation:spin 1.4s linear infinite reverse;}
@keyframes spin{to{transform:rotate(360deg);}}
.ov-icon{font-size:40px;}
.ov-text{font-size:20px;font-weight:800;color:var(--blue);letter-spacing:-0.5px;}
.ov-sub{font-size:13px;font-family:'DM Mono',monospace;color:var(--sub);animation:blink 1s ease infinite;}

/* DOTS */
.dots-bar{
  position:fixed;bottom:calc(var(--safe-bot) + 8px);
  left:50%;transform:translateX(-50%);
  display:flex;gap:6px;align-items:center;z-index:100;pointer-events:none;
}
.dot-ind{width:6px;height:6px;border-radius:100px;background:var(--dot);transition:all 0.3s;}
.dot-ind.active{width:22px;background:var(--lime);}

button{font-family:inherit;}
</style>
</head>
<body>

<!-- DOTS -->
<div class="dots-bar">
  <div class="dot-ind active" id="dot0"></div>
  <div class="dot-ind" id="dot1"></div>
  <div class="dot-ind" id="dot2"></div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay">
  <div class="ov-rings">
    <div class="ov-spin"></div>
    <div class="ov-spin2"></div>
    <div class="ov-icon">üì°</div>
  </div>
  <div class="ov-text">Leyendo NFC‚Ä¶</div>
  <div class="ov-sub">Mant√©n el dispositivo cerca</div>
</div>

<!-- SLIDER -->
<div class="slider" id="slider">

  <!-- SLIDE 1: SETUP -->
  <div class="slide" id="s1">
    <div class="s1-inner">
      <div class="status-bar">
        <span id="clock">--:--</span>
        <div class="status-icons">
          <span style="font-size:14px">‚ñ≤‚ñ≤‚ñ≤</span>
          <span style="font-size:14px">üîã</span>
        </div>
      </div>
      <div class="app-header">
        <div class="app-logo">
          <div class="logo-mark">‚ö°</div>
          <div class="logo-text">Tap<span>Pay</span></div>
        </div>
        <div class="header-badge">NFC v2</div>
      </div>

      <div class="section-eyebrow">Importe a cobrar</div>
      <div class="amount-display">
        <span class="euro-sign">‚Ç¨</span>
        <input class="amount-input-big" type="number" id="amt" placeholder="0" min="0.01" step="0.01" inputmode="decimal">
      </div>

      <div class="quick-row">
        <button class="qbtn" onclick="setAmt(1)">‚Ç¨1</button>
        <button class="qbtn" onclick="setAmt(5)">‚Ç¨5</button>
        <button class="qbtn" onclick="setAmt(10)">‚Ç¨10</button>
        <button class="qbtn" onclick="setAmt(20)">‚Ç¨20</button>
        <button class="qbtn" onclick="setAmt(50)">‚Ç¨50</button>
        <button class="qbtn" onclick="setAmt(100)">‚Ç¨100</button>
      </div>

      <div class="divider-line"></div>

      <div class="upload-label-row">
        <span class="section-eyebrow" style="margin-bottom:0">Imagen de confirmaci√≥n</span>
        <span style="font-size:11px;color:var(--sub);font-family:'DM Mono',monospace">Opcional</span>
      </div>
      <div class="upload-zone" id="uz" onclick="document.getElementById('file-input').click()">
        <div class="uz-icon">üñºÔ∏è</div>
        <div class="uz-text"><b>Toca para subir imagen</b><br>Aparecer√° tras el pago</div>
        <div class="uz-overlay">‚úèÔ∏è Cambiar</div>
      </div>
      <input type="file" id="file-input" accept="image/*" onchange="handleImg(event)">

      <div class="flex-grow"></div>

      <button class="cta-main" id="cta" onclick="goPay()" disabled>
        <span>Ir a pagar</span>
        <div class="cta-arrow">‚Üí</div>
      </button>
      <div class="swipe-hint">‚Üê desliza para navegar ‚Üí</div>
    </div>
  </div>

  <!-- SLIDE 2: PAYMENT -->
  <div class="slide" id="s2">
    <div class="s2-inner">
      <div class="pay-topbar">
        <div class="pay-back" onclick="cancelPay()">‚Üê</div>
        <div class="pay-title">Pago seguro</div>
        <div class="pay-secure">üîí SSL</div>
      </div>
      <div class="amount-card">
        <div class="ac-label">Total a cobrar</div>
        <div class="ac-amount" id="pay-amt">‚Ç¨0,00</div>
        <div class="ac-sub" id="pay-sub">Activa el lector NFC para pagar</div>
      </div>

      <!-- NFC STATUS PANEL -->
      <div class="nfc-panel" id="nfc-panel">

        <!-- STATE: idle -->
        <div class="nfc-state" id="nfc-idle">
          <div class="nfc-stage-idle" onclick="activarNFC()">
            <div class="nfc-core-idle">
              <span style="font-size:32px">üì∂</span>
            </div>
            <div class="nfc-idle-label">Toca para activar NFC</div>
          </div>
        </div>

        <!-- STATE: listening -->
        <div class="nfc-state hidden" id="nfc-listening">
          <div class="nfc-stage">
            <div class="nfc-ring"></div>
            <div class="nfc-ring"></div>
            <div class="nfc-ring"></div>
            <div class="nfc-core">
              <div class="nfc-icon">üì∂</div>
            </div>
          </div>
          <div class="nfc-text">
            <div class="nfc-text-main">Esperando tarjeta o m√≥vil‚Ä¶</div>
            <div class="nfc-text-sub" id="nfc-listen-sub">NFC activo ¬∑ acerca el dispositivo</div>
          </div>
        </div>

        <!-- STATE: not supported -->
        <div class="nfc-state hidden" id="nfc-nosupport">
          <div style="text-align:center;padding:20px 0;">
            <div style="font-size:40px;margin-bottom:12px">üìµ</div>
            <div style="font-size:15px;font-weight:700;margin-bottom:6px;color:var(--text)">NFC no disponible</div>
            <div style="font-size:12px;color:var(--sub);font-family:'DM Mono',monospace;line-height:1.6">
              Requiere Android + Chrome + HTTPS<br>Usa el bot√≥n de abajo para simular
            </div>
          </div>
        </div>

        <!-- STATE: error -->
        <div class="nfc-state hidden" id="nfc-error">
          <div style="text-align:center;padding:20px 0;">
            <div style="font-size:40px;margin-bottom:12px">‚ö†Ô∏è</div>
            <div style="font-size:15px;font-weight:700;margin-bottom:6px;color:#ff6b6b">Error NFC</div>
            <div style="font-size:12px;color:var(--sub);font-family:'DM Mono',monospace;line-height:1.6" id="nfc-error-msg">
              No se pudo acceder al NFC
            </div>
            <button class="retry-btn" onclick="activarNFC()">Reintentar</button>
          </div>
        </div>

      </div><!-- /nfc-panel -->

      <button class="sim-btn" onclick="simularNFC()">‚ö° Simular pago NFC</button>
      <div class="cancel-link" onclick="cancelPay()">Cancelar pago</div>
    </div>
  </div>

  <!-- SLIDE 3: SUCCESS -->
  <div class="slide" id="s3">
    <div class="s3-inner">
      <div class="success-topbar">
        <div class="success-chip">
          <div class="chip-dot"></div>
          NFC Le√≠do
        </div>
        <div class="success-topbar-right" id="s3-time">--:--</div>
      </div>
      <div class="success-hero">
        <div class="success-tick">‚úÖ</div>
        <div class="success-title-main">¬°Pago aceptado!</div>
        <div class="success-amount-hero" id="s3-amt"></div>
      </div>
      <div id="s3-img-wrap"></div>
      <div class="txn-card">
        <div class="txn-row">
          <span class="txn-k">Estado</span>
          <span class="txn-v ok">‚úî APROBADO</span>
        </div>
        <div class="txn-row">
          <span class="txn-k">M√©todo</span>
          <span class="txn-v">NFC Contactless</span>
        </div>
        <div class="txn-row">
          <span class="txn-k">Referencia</span>
          <span class="txn-v" id="s3-ref">‚Äî</span>
        </div>
        <div class="txn-row">
          <span class="txn-k">Fecha</span>
          <span class="txn-v" id="s3-date">‚Äî</span>
        </div>
      </div>
      <button class="reset-btn" onclick="reset()">+ Nuevo cobro</button>
    </div>
  </div>

</div>

<script>
let amount = 0, imgData = null, currentSlide = 0, isReading = false;
let nfcReader = null; // persistent NDEFReader instance

// Clock
function updateClock(){
  const n = new Date();
  document.getElementById('clock').textContent =
    n.getHours().toString().padStart(2,'0')+':'+n.getMinutes().toString().padStart(2,'0');
}
updateClock(); setInterval(updateClock,10000);

// Slider
function goSlide(n, force){
  if(!force && n===1 && amount<=0) return;
  currentSlide = n;
  document.getElementById('slider').style.transform = `translateX(-${n*33.333}%)`;
  ['dot0','dot1','dot2'].forEach((id,i)=>
    document.getElementById(id).classList.toggle('active',i===n));
  document.getElementById(['s1','s2','s3'][n]).scrollTop = 0;
}

// Swipe
let tx=0, ty=0;
document.addEventListener('touchstart', e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend', e=>{
  if(isReading) return;
  const dx = e.changedTouches[0].clientX-tx;
  const dy = e.changedTouches[0].clientY-ty;
  if(Math.abs(dx)<50 || Math.abs(dy)>Math.abs(dx)*1.2) return;
  if(dx<0){
    if(currentSlide===0 && amount>0) goPay();
  } else {
    if(currentSlide===1) cancelPay();
    if(currentSlide===2) goSlide(0);
  }
},{passive:true});

// Amount
const amtEl = document.getElementById('amt');
const ctaEl = document.getElementById('cta');
amtEl.addEventListener('input',()=>{
  amount = parseFloat(amtEl.value)||0;
  ctaEl.disabled = amount<=0;
  document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('active'));
});
function setAmt(v){
  amtEl.value=v; amount=v; ctaEl.disabled=false;
  document.querySelectorAll('.qbtn').forEach(b=>
    b.classList.toggle('active', parseFloat(b.textContent.replace('‚Ç¨',''))===v));
}

// Image
function handleImg(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    imgData=ev.target.result;
    const uz=document.getElementById('uz');
    uz.classList.add('filled');
    uz.innerHTML=`<img src="${imgData}" alt="preview"><div class="uz-overlay">‚úèÔ∏è Cambiar</div>`;
    uz.onclick=()=>document.getElementById('file-input').click();
  };
  r.readAsDataURL(f);
}

// Go to payment
function goPay(){
  if(amount<=0) return;
  document.getElementById('pay-amt').textContent = fmt(amount);
  document.getElementById('pay-sub').textContent = 'Activa el lector NFC para pagar';
  setNFCState('idle');
  goSlide(1);
}

// Cancel payment ‚Äî stop NFC scan if active
function cancelPay(){
  stopNFC();
  goSlide(0);
}

// ‚îÄ‚îÄ‚îÄ NFC STATE MANAGER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setNFCState(state){ // idle | listening | nosupport | error
  ['idle','listening','nosupport','error'].forEach(s=>{
    document.getElementById('nfc-'+s).classList.toggle('hidden', s!==state);
  });
}

// ‚îÄ‚îÄ‚îÄ ACTIVATE NFC (called from user gesture) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function activarNFC(){
  if(!('NDEFReader' in window)){
    setNFCState('nosupport');
    return;
  }

  setNFCState('listening');
  document.getElementById('nfc-listen-sub').textContent = 'Iniciando lector NFC‚Ä¶';
  document.getElementById('pay-sub').textContent = 'NFC activo ¬∑ acerca tu dispositivo';

  try {
    // Stop any previous reader
    stopNFC();

    nfcReader = new NDEFReader();

    // onreading fires when a tag/card is detected
    nfcReader.onreading = (event) => {
      if(currentSlide === 1 && !isReading){
        readNFCSuccess();
      }
    };

    nfcReader.onreadingerror = (event) => {
      document.getElementById('nfc-listen-sub').textContent = 'Error de lectura ¬∑ reintenta';
    };

    await nfcReader.scan(); // This requires a user gesture ‚Äî we are inside onclick ‚úì

    document.getElementById('nfc-listen-sub').textContent = 'NFC activo ¬∑ acerca el dispositivo';

  } catch(err) {
    let msg = 'No se pudo acceder al NFC.';
    if(err.name === 'NotAllowedError')
      msg = 'Permiso denegado. Act√≠valo en ajustes del navegador.';
    else if(err.name === 'NotSupportedError')
      msg = 'NFC no soportado en este dispositivo.';
    else if(err.name === 'NotReadableError')
      msg = 'El hardware NFC est√° ocupado o apagado.';
    else if(err.message)
      msg = err.message;

    document.getElementById('nfc-error-msg').textContent = msg;
    setNFCState('error');
    nfcReader = null;
  }
}

function stopNFC(){
  // NDEFReader has no explicit stop in the spec,
  // but replacing the reference and letting GC handle it
  // stops new events from the old reader instance.
  nfcReader = null;
}

// ‚îÄ‚îÄ‚îÄ CALLED WHEN REAL NFC TAG IS READ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function readNFCSuccess(){
  if(isReading) return;
  isReading = true;
  stopNFC();
  document.getElementById('overlay').classList.add('show');
  // Brief delay for visual feedback then show success
  setTimeout(()=>{
    document.getElementById('overlay').classList.remove('show');
    isReading = false;
    showSuccess();
  }, 900);
}

// ‚îÄ‚îÄ‚îÄ SIMULATE NFC (fallback button) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function simularNFC(){
  if(isReading) return;
  isReading = true;
  stopNFC();
  setNFCState('idle'); // reset UI
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>{
    document.getElementById('overlay').classList.remove('show');
    isReading = false;
    showSuccess();
  }, 1400 + Math.random()*800);
}

function showSuccess(){
  const now=new Date();
  document.getElementById('s3-amt').textContent=fmt(amount);
  document.getElementById('s3-time').textContent=
    now.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('s3-ref').textContent=
    'TXN'+Math.random().toString(36).slice(2,8).toUpperCase();
  document.getElementById('s3-date').textContent=
    now.toLocaleDateString('es-ES')+' ¬∑ '+
    now.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});

  const iw=document.getElementById('s3-img-wrap');
  iw.innerHTML = imgData
    ? `<div class="img-frame" onclick="abrirFullscreen()" title="Toca para ver en pantalla completa">
         <img src="${imgData}" alt="Confirmaci√≥n">
         <div class="img-frame-label">üì∑ Toca para pantalla completa</div>
         <div class="img-expand-icon">‚õ∂</div>
       </div>`
    : `<div class="no-img-box">üñºÔ∏è Sin imagen seleccionada</div>`;

  goSlide(2,true);
}

// Reset
function reset(){
  amount=0; imgData=null;
  amtEl.value=''; ctaEl.disabled=true;
  document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('active'));
  const uz=document.getElementById('uz');
  uz.classList.remove('filled');
  uz.innerHTML=`<div class="uz-icon">üñºÔ∏è</div><div class="uz-text"><b>Toca para subir imagen</b><br>Aparecer√° tras el pago</div><div class="uz-overlay">‚úèÔ∏è Cambiar</div>`;
  uz.onclick=()=>document.getElementById('file-input').click();
  document.getElementById('file-input').value='';
  stopNFC();
  goSlide(0);
}

function fmt(v){ return '‚Ç¨'+v.toFixed(2).replace('.',','); }

// Fullscreen image viewer
function abrirFullscreen(){
  if(!imgData) return;
  document.getElementById('fs-img').src = imgData;
  const v = document.getElementById('fs-viewer');
  v.classList.add('open');
  // Try native fullscreen on Android
  if(v.requestFullscreen) v.requestFullscreen().catch(()=>{});
  else if(v.webkitRequestFullscreen) v.webkitRequestFullscreen();
  // Prevent scroll behind
  document.body.style.overflow = 'hidden';
}

function cerrarFullscreen(){
  const v = document.getElementById('fs-viewer');
  v.classList.remove('open');
  if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});
  else if(document.webkitFullscreenElement) document.webkitExitFullscreen();
  document.body.style.overflow = '';
}

// Close fullscreen with back gesture / Escape
document.addEventListener('keydown', e=>{ if(e.key==='Escape') cerrarFullscreen(); });
document.addEventListener('fullscreenchange', ()=>{ if(!document.fullscreenElement) cerrarFullscreen(); });
document.addEventListener('webkitfullscreenchange', ()=>{ if(!document.webkitFullscreenElement) cerrarFullscreen(); });
</script>
<!-- FULLSCREEN IMAGE VIEWER -->
<div class="fs-viewer" id="fs-viewer" onclick="cerrarFullscreen()">
  <img id="fs-img" src="" alt="Pantalla completa">
  <div class="fs-close">‚úï</div>
  <div class="fs-hint">Toca para cerrar</div>
</div>

</body>
</html>
